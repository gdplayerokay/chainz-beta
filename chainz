#!/usr/bin/env bash

VERSION="Chainz 1.4 (Major Update)"
cmd="$1"
pkg="$2"

# --------------------------
# Detect OS Package Managers
# --------------------------
HAS_PACMAN=0
HAS_YAY=0
HAS_APT=0
HAS_DNF=0

command -v pacman >/dev/null 2>&1 && HAS_PACMAN=1
command -v yay    >/dev/null 2>&1 && HAS_YAY=1
command -v apt    >/dev/null 2>&1 && HAS_APT=1
command -v dnf    >/dev/null 2>&1 && HAS_DNF=1

# --- Mutually exclusive rules ---
# If apt exists → disable pacman, dnf, yay
if [[ $HAS_APT -eq 1 ]]; then
    HAS_PACMAN=0
    HAS_YAY=0
    HAS_DNF=0
fi

# If dnf exists → disable apt, pacman, yay
if [[ $HAS_DNF -eq 1 ]]; then
    HAS_PACMAN=0
    HAS_YAY=0
    HAS_APT=0
fi

# If pacman exists → disable apt, dnf
if [[ $HAS_PACMAN -eq 1 ]]; then
    HAS_APT=0
    HAS_DNF=0
fi

# --------------------------
# Update notes (notes)
# --------------------------
if [[ "$cmd" == "notes" ]]; then
    echo "These are the 1.4 update notes:"
    echo "1. New Apt Support!"
    echo "2. Re-addition of Flatpak"
    echo "3. NEW: DNF support (Fedora)"
    echo "4. NEW: OS auto-detection"
    exit 1
fi

# --------------------------
# Check Dependencies
# --------------------------
command -v fzf >/dev/null 2>&1 || {
    echo "fzf not installed"
    echo "Install it with your system package manager."
    exit 1
}

# --------------------------
# Version
# --------------------------
if [[ "$cmd" == "-v" || "$cmd" == "--version" ]]; then
    echo "$VERSION"
    exit 0
fi

# --------------------------
# Interactive Mode
# --------------------------
if [[ -z "$cmd" ]]; then
    cmd=$(printf "Install packages\nRemove packages\nUpgrade packages\nExit" | \
        fzf --prompt="What do you want to do? > " --height=10% --reverse --border)

    case "$cmd" in
        "Install packages") cmd="-I";;
        "Remove packages")  cmd="-R";;
        "Upgrade packages") cmd="-U";;
        "Exit"|"") exit 0;;
        *) echo -e "\e[31mInvalid Choice"; exit 1;;
    esac
fi

# -------------------------
# Update/Upgrade (-U)
# -------------------------
if [[ "$cmd" == "-U" ]]; then
    echo "=== Chainz System Upgrade ==="
    echo

    if [[ $HAS_PACMAN -eq 1 ]]; then
        echo "→ Updating Pacman packages..."
        sudo pacman -Syu --noconfirm || { echo "Pacman update failed"; exit 1; }
        echo
    fi

    if [[ $HAS_YAY -eq 1 ]]; then
        echo "→ Updating Yay packages..."
        yay -Syu --noconfirm || { echo "Yay update failed"; exit 1; }
        echo
    fi

    if [[ $HAS_APT -eq 1 ]]; then
        echo "→ Updating APT packages..."
        sudo apt update -y   || { echo "APT update failed"; exit 1; }
        sudo apt upgrade -y  || { echo "APT upgrade failed"; exit 1; }
        echo
    fi

    if [[ $HAS_DNF -eq 1 ]]; then
        echo "→ Updating DNF packages..."
        sudo dnf upgrade --refresh -y || { echo "DNF update failed"; exit 1; }
        echo
    fi

    echo "=== All package managers updated ==="
    exit 0
fi

# -------------------------
# Help (--help)
# -------------------------
if [[ "$cmd" == "-h" || "$cmd" == "--help" ]]; then
    echo "Chainz - Universal Package Manager Wrapper"
    echo "Version: $VERSION"
    echo
    echo "Usage:"
    echo "  chainz -I          Install a package"
    echo "  chainz -R          Remove a package"
    echo "  chainz -U          Upgrade all packages"
    echo "  chainz notes       Show update notes"
    echo "  chainz -v          Show version"
    exit 0
fi

# -------------------------
# Remove (-R)
# -------------------------
if [[ "$cmd" == "-R" ]]; then

    echo "Select package type to remove:"
    pkg_type=$(printf "Pacman\nFlatpak" | \
        fzf --prompt="Type> " --height 10% --reverse --border)

    if [[ "$pkg_type" == "Pacman" ]]; then
        if [[ $HAS_PACMAN -ne 1 ]]; then echo "Pacman not available"; exit 1; fi

        mapfile -t pacman_pkgs < <(pacman -Q | awk '{print $1}')

        [[ ${#pacman_pkgs[@]} -eq 0 ]] && { echo "No pacman packages."; exit 1; }

        pkg_to_remove=$(printf "%s\n" "${pacman_pkgs[@]}" | fzf)
        [[ -z "$pkg_to_remove" ]] && exit 1

        sudo pacman -R "$pkg_to_remove"
        exit 0
    fi

    if [[ "$pkg_type" == "Flatpak" ]]; then
        mapfile -t flatpak_pkgs < <(flatpak list --app --columns=application)
        [[ ${#flatpak_pkgs[@]} -eq 0 ]] && { echo "No Flatpaks."; exit 1; }

        pkg_to_remove=$(printf "%s\n" "${flatpak_pkgs[@]}" | fzf)
        [[ -z "$pkg_to_remove" ]] && exit 1

        flatpak uninstall -y "$pkg_to_remove"
        exit 0
    fi

    echo "Invalid selection."
    exit 1
fi

# -------------------------
# Install (-I)
# -------------------------
if [[ "$cmd" == "-I" ]]; then

    echo "Select the package manager:"
    manager_list=""

    [[ $HAS_PACMAN -eq 1 ]] && manager_list+="Pacman (Arch)\n"
    [[ $HAS_YAY    -eq 1 ]] && manager_list+="Yay (AUR)\n"
    manager_list+="Flatpak (Universal)\n"
    [[ $HAS_APT    -eq 1 ]] && manager_list+="Apt (Ubuntu)\n"
    [[ $HAS_DNF    -eq 1 ]] && manager_list+="DNF (Fedora)\n"

    manager=$(printf "$manager_list" | \
        fzf --prompt="Package manager> " --height 10% --reverse --border)

    [[ -z "$manager" ]] && exit 1

    case "$manager" in
        "Pacman (Arch)") pkgs=($(pacman -Sl | awk '{print $2}'));;
        "Yay (AUR)") pkgs=($(yay -Ssq));;
        "Flatpak (Universal)") pkgs=($(flatpak search "" | awk '{print $1}'));;
        "Apt (Ubuntu)") mapfile -t pkgs < <(apt list 2>/dev/null | cut -d/ -f1);;
        "DNF (Fedora)") mapfile -t pkgs < <(dnf list available | awk '{print $1}');;
        *) echo "Invalid manager"; exit 1;;
    esac

    pkg=$(printf "%s\n" "${pkgs[@]}" | fzf)
    [[ -z "$pkg" ]] && exit 1

    case "$manager" in
        "Pacman (Arch)") sudo pacman -S "$pkg";;
        "Yay (AUR)") yay -S "$pkg";;
        "Flatpak (Universal)") flatpak install -y "$pkg";;
        "Apt (Ubuntu)") sudo apt install -y "$pkg";;
        "DNF (Fedora)") sudo dnf install -y "$pkg";;
    esac

    exit 0
fi
